<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watauga County Debris Management Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styling for the dashboard */
        :root {
            /* Adjusted colors for better contrast on light background */
            --watauga-blue: #1C6E8D; /* Deep Blue for contrast on light background */
            --watauga-gold: #FFC300; /* Gold for accents */
            --card-bg: rgba(255, 255, 255, 0.4); /* Frosted Glass (light/colorless) */
            --border-color: rgba(0, 0, 0, 0.1); /* Light border */
            --text-color: #1F2937; /* Dark text for readability on light background */
        }

        /* Utility classes using the new colors */
        .text-watauga-blue { color: var(--watauga-blue); }
        .bg-watauga-blue { background-color: var(--watauga-blue); }
        .border-watauga-blue { border-color: var(--watauga-blue); }

        body {
            /* Opaque Glass Background: Light, colorless foundation */
            background-color: #F3F4F6; 
            color: var(--text-color); 
        }

        /* Glassmorphism Effect Class (Frosted Glass Containers) */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(15px); /* Key for frosted glass */
            -webkit-backdrop-filter: blur(15px); /* Safari support */
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.1); /* Subtle shadow for lift */
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .glass-card:hover {
            box-shadow: 0 8px 24px 0 rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        /* Adjustments for text and internal elements */
        #app h1 {
            color: var(--watauga-blue); /* Header text stand out */
            text-shadow: none;
        }
        
        #app p {
            color: var(--text-color); /* Darker gray for secondary text */
        }

        #chart-title {
            color: var(--watauga-blue); /* Chart titles use primary accent color */
            text-shadow: none;
            text-align: left;
        }
        
        .clin-section-header {
            color: var(--watauga-blue); /* Section headers use primary accent color */
            border-bottom-color: var(--watauga-blue);
            text-shadow: none;
            font-weight: bold;
        }
        
        /* Specific styling for internal CLIN card text to ensure readability */
        .clin-card-text {
            color: var(--text-color);
        }
        .clin-card-description {
            color: #4B5563; /* Medium gray */
        }
        .clin-card-metric-label {
            color: #6B7280; /* Slightly lighter gray */
        }
        .clin-card-metric-value {
            color: var(--text-color);
            font-weight: 900;
        }
        .text-watauga-gold {
            color: var(--watauga-gold);
        }

        /* --- CSS for Spinning Seal (Animation Definition) --- */
        @keyframes coin-spin {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        /* Base class: Ensures 3D style is preserved, but no animation by default */
        .watauga-seal {
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out; /* Smooth hover transition if needed */
        }

        /* Hover class: Applies the animation when the mouse is over the element */
        .watauga-seal:hover {
            animation: coin-spin 2s linear infinite; /* Faster spin on hover */
        }

        /* Style for the new container wrapping each CLIN section */
        .clin-section-wrapper {
            margin-bottom: 2rem;
            padding: 1rem;
            border-radius: 12px;
            /* Use a slightly more opaque background for section wrapper for clear distinction */
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Adjust internal header style when inside the new wrapper */
        .clin-section-wrapper .clin-section-header {
            border-bottom: none; /* Remove bottom border since the wrapper provides separation */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

    </style>
</head>
<body class="font-sans p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- Dashboard Header & Logos (Frosted Glass Applied) -->
        <header class="flex flex-col sm:flex-row justify-between items-center glass-card mb-8">
            <!-- Watauga County Seal (Spinning on Hover) -->
            <div class="mb-4 sm:mb-0">
                <!-- Watauga Seal Path -->
                <!-- Note: The class is now 'watauga-seal' and the spin animation is triggered via CSS :hover -->
                <img src="assets/watauga_seal.png" onerror="this.onerror=null; this.src='https://placehold.co/100x100/0A3D62/FFFFFF?text=Watauga+Seal';" alt="Seal of Watauga County" class="h-20 w-auto rounded-full shadow-lg watauga-seal cursor-pointer">
            </div>

            <!-- Title -->
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">USACE Watauga County Debris Report</h1>
                <p class="mt-1 text-sm md:text-base clin-card-description">Progress Snapshot as of September 28, 2025</p>
            </div>

            <!-- Thompson Consulting Services Logo -->
            <div class="mt-4 sm:mt-0">
                <!-- Thompson Logo Path - Assuming this file is a PNG with a transparent background -->
                <img src="assets/tcs_logo.png" onerror="this.onerror=null; this.src='https://placehold.co/180x60/FFC300/0A3D62?text=Thompson+Consulting';" alt="Thompson Consulting Services Logo" class="h-14 w-auto object-contain">
            </div>
        </header>

        <!-- Key Performance Indicators (KPIs) -->
        <div id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- KPIs will be dynamically added here -->
        </div>

        <!-- Charts Section: Now only two full-width sections for Volume and CLINs -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- 1. Debris Volume Breakdown Chart (Pie Chart) - Spans full width (Frosted Glass Applied) -->
            <div class="col-span-full glass-card border-t-4 border-watauga-blue" style="border-top-width: 4px;">
                <div id="chart-title" class="text-center">Volume by Debris Class (CY)</div>
                <div id="volume-chart" class="flex justify-center items-center h-80">
                    <svg id="volume-pie-chart" class="w-full h-full"></svg>
                </div>
                <p class="text-sm mt-4 text-center clin-card-description">Breakdown based on recorded debris class totals.</p>
            </div>
        
            <!-- 2. CLIN Performance Status (Cards/Rows) - Spans all columns (Frosted Glass Applied) -->
            <div class="col-span-full glass-card flex flex-col border-t-4 border-watauga-blue" style="border-top-width: 4px;">
                <div id="chart-title">CLIN NTE Breakdown</div>
                <!-- CLIN cards container: Responsive grid for optimal viewing of many CLINs -->
                <div id="clin-breakdown-container" class="flex-grow">
                    <!-- CLIN sections and cards will be injected here by JavaScript -->
                </div>
                <p class="text-sm mt-4 text-center clin-card-description">NTE Completion Status by Contract Line Item Number. (Estimated NTE for non-volume CLINs)</p>
            </div>

        </div>

    </div>

    <script>
        // --- Data Setup ---
        
        const totalVolumeToDateCY = 34877.87; 
        const projectDaysElapsed = 58; // Mock: Aug 1 to Sept 28, 2025

        // New Structured Data: Grouped CLINs for Section Titles
        const clinSections = [
            {
                title: "AUTOMATED DEBRIS MANAGEMENT SYSTEM",
                clin: [
                    {
                        clin: "CLIN 0001",
                        description: "AUTOMATED DEBRIS MANAGEMENT SYSTEM UP TO 500,000 CY",
                        uom: "CY",
                        nteQuantity: 364182,
                        to_date_quantity: 34877.87,
                        percent: 9.58,
                    },
                ]
            },
            {
                title: "CREWS / STAFFING",
                clin: [
                    {
                        clin: "CLIN 0002",
                        description: "DEBRIS SEPARATION CREW",
                        uom: "Crew Day",
                        nteQuantity: 60,
                        to_date_quantity: 831,
                        percent: 1385.00,
                    },
                    {
                        clin: "CLIN 0003",
                        description: "EMERGENCY ROAD CLEARANCE (HHW) CREW",
                        uom: "Crew Day",
                        nteQuantity: 30,
                        to_date_quantity: 18,
                        percent: 60.00,
                    },
                    {
                        clin: "CLIN 0004",
                        description: "HOUSEHOLD HAZARDOUS WASTE SEPARATION CREW",
                        uom: "Crew Day",
                        nteQuantity: 60,
                        to_date_quantity: 0,
                        percent: 0.00,
                    },
                    {
                        clin: "CLIN 0005",
                        description: "HTRW SEPARATION CREW (MOCK NTE)",
                        uom: "Crew Day",
                        nteQuantity: 30,
                        to_date_quantity: 0,
                        percent: 0.00,
                    },
                ]
            },
            {
                title: "EQUIPMENT (NON-UNIT RATES)",
                clin: [
                    {
                        clin: "CLIN 0006",
                        description: "DUMP TRUCKS (C&D / VEG) (MOCK NTE)",
                        uom: "Truck Hr",
                        nteQuantity: 1500,
                        to_date_quantity: 350.5,
                        percent: (350.5 / 1500 * 100).toFixed(2),
                    },
                ]
            },
            {
                title: "DEBRIS REMOVAL",
                clin: [
                    {
                        clin: "CLIN 0009",
                        description: "Vegetative Debris Removal Parcel to DMS FDS (0-15 CY)",
                        uom: "CY",
                        nteQuantity: 250000,
                        to_date_quantity: 60484.49,
                        percent: (60484.49 / 250000 * 100).toFixed(2),
                    },
                    {
                        clin: "CLIN 0012",
                        description: "C&D Debris Removal Parcel to DMS FDS (0-15 CY)",
                        uom: "CY",
                        nteQuantity: 8000,
                        to_date_quantity: 1803.00,
                        percent: (1803.00 / 8000 * 100).toFixed(2),
                    },
                    {
                        clin: "CLIN 0013",
                        description: "C&D Debris Removal Parcel to DMS FDS (16-30 CY)",
                        uom: "CY",
                        nteQuantity: 2000,
                        to_date_quantity: 111.80,
                        percent: (111.80 / 2000 * 100).toFixed(2),
                    },
                ]
            },
            {
                title: "DISPOSAL / REDUCTION",
                clin: [
                    {
                        clin: "CLIN 0016",
                        description: "Debris Reduction at DMS Non Urban CD Compact",
                        uom: "CY",
                        nteQuantity: 2500,
                        to_date_quantity: 1023.2,
                        percent: (1023.2 / 2500 * 100).toFixed(2),
                    },
                    {
                        clin: "CLIN 0017",
                        description: "Final Disposal Reduced Chips Mulch (31-60 Miles)",
                        uom: "CY",
                        nteQuantity: 30000,
                        to_date_quantity: 14566.40,
                        percent: (14566.40 / 30000 * 100).toFixed(2),
                    },
                    {
                        clin: "CLIN 0018",
                        description: "Final Disposal Compact CD (31-60 Miles)",
                        uom: "CY",
                        nteQuantity: 3000,
                        to_date_quantity: 1023.2,
                        percent: (1023.2 / 3000 * 100).toFixed(2),
                    },
                ]
            },
            {
                title: "OTHER PASS-THROUGH",
                clin: [
                    {
                        clin: "CLIN 0020",
                        description: "TDMS - SITE ACCESSES LEASE (Unencumbered Pass Through)",
                        uom: "CY",
                        nteQuantity: 335046, 
                        to_date_quantity: 33920.47,
                        percent: 10.12,
                    },
                ]
            }
        ];

        const projectData = {
            projectGoalCY: 364182,
            volumeToDateCY: totalVolumeToDateCY,
            percentComplete: 9.58,
            projectDaysElapsed: projectDaysElapsed,
            volumeBreakdown: [
                { class: "Vegetative (Non Urban)", cy: 27902, color: "#10B981" }, /* Green for Veg */
                { class: "C&D (Non Urban)", cy: 5232, color: "#F59E0B" }, /* Amber for C&D */
                { class: "Mulch/Reduced Chips", cy: 1744, color: "#78350F" } /* Brown for Mulch */
            ],
            clinSections: clinSections, 
        };

        const totalVolumeBreakdown = projectData.volumeBreakdown.reduce((sum, item) => sum + item.cy, 0);

        // --- D3 Charting Functions ---

        /**
         * Renders the Pie Chart for Debris Volume Breakdown.
         */
        function renderVolumeChart() {
            const data = projectData.volumeBreakdown;
            const container = d3.select("#volume-pie-chart");
            container.selectAll("*").remove(); // Clear previous chart
            const width = 400, height = 400; 
            const radius = Math.min(width, height) / 2 - 10;

            const svg = container
                .attr("viewBox", `0 0 ${width} ${height}`)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            const pie = d3.pie()
                .value(d => d.cy)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius * 0.8);

            // Use the data colors directly
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.class))
                .range(data.map(d => d.color));

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("position", "absolute")
                .style("background", "rgba(0, 0, 0, 0.7)")
                .style("color", "white")
                .style("padding", "8px")
                .style("border-radius", "6px")
                .style("pointer-events", "none"); // Tooltip should not block mouse events

            // Build the pie chart
            const arcs = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.class))
                .attr("stroke", "rgba(255, 255, 255, 0.8)") /* Light border for contrast on dark pie */
                .style("stroke-width", "2px")
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    const percentage = (d.data.cy / totalVolumeBreakdown * 100).toFixed(1);
                    tooltip.html(`<strong>${d.data.class}</strong><br/>${d.data.cy.toLocaleString()} CY<br/>(${percentage}%)`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    d3.select(event.currentTarget)
                        .transition()
                        .duration(150)
                        .attr("transform", `scale(1.03)`);
                })
                .on("mouseout", (event, d) => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                    d3.select(event.currentTarget)
                        .transition()
                        .duration(150)
                        .attr("transform", `scale(1)`);
                });

            // Add Text Labels
            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", ".35em")
                .attr("class", "pointer-events-none")
                .style("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "white")
                .style("font-weight", "bold")
                .style("text-shadow", "1px 1px 2px rgba(0,0,0,0.8)")
                .text(d => (d.data.cy / totalVolumeBreakdown * 100).toFixed(0) + '%')
                .filter(d => (d.data.cy / totalVolumeBreakdown * 100) < 5) // Hide small labels
                .remove();

            // Add Legend
            const legendX = radius + 10;
            const legendY = -radius + 10;

            const legend = svg.selectAll(".legend")
                .data(data)
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(${legendX}, ${i * 20 - height / 4})`);

            legend.append("rect")
                .attr("x", 0)
                .attr("width", 12)
                .attr("height", 12)
                .style("fill", d => color(d.class))
                .attr("rx", 3);

            legend.append("text")
                .attr("x", 18)
                .attr("y", 6)
                .attr("dy", ".35em")
                .style("text-anchor", "start")
                .style("font-size", "12px")
                .style("fill", "var(--text-color)")
                .text(d => d.class);
        }

        /**
         * Renders the CLIN Breakdown as a series of individual cards/rows, grouped by section.
         */
        function renderClinBreakdownCards() {
            const sections = projectData.clinSections;
            const container = document.getElementById('clin-breakdown-container');
            container.innerHTML = ''; // Clear existing content

            const sectionsHtml = sections.map(section => {
                const cardsHtml = section.clin.map(item => {
                    let percentValue = parseFloat(item.percent);
                    if (isNaN(percentValue) && item.nteQuantity > 0) {
                         percentValue = (item.to_date_quantity / item.nteQuantity * 100);
                    } else if (isNaN(percentValue)) {
                        percentValue = 0;
                    }
                    
                    const percentText = percentValue.toFixed(2);
                    const barWidth = Math.min(100, percentValue); 
                    const barColor = percentValue >= 100 ? 'bg-red-500' : 'bg-watauga-blue';
                    const textColor = percentValue >= 100 ? 'text-red-500 font-bold' : 'text-watauga-blue';
                    const formattedNTE = item.nteQuantity.toLocaleString();
                    const formattedToDate = item.to_date_quantity.toLocaleString();
                    const status = percentValue >= 100 ? 'EXCEEDED' : 'On Track';

                    return `
                        <!-- Individual Row Container (Inner translucent card) -->
                        <div class="p-3 rounded-xl border border-gray-200/50 bg-white/50 hover:bg-white/70 transition duration-150 shadow-inner">
                            
                            <!-- CLIN Header & Percentage -->
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-base font-bold clin-card-text">${item.clin}</h4>
                                <span class="text-sm ${textColor}">${percentText}% Complete</span>
                            </div>

                            <p class="text-xs clin-card-description truncate mb-2" title="${item.description}">${item.description}</p>

                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-300 rounded-full h-3 mb-3">
                                <div class="h-3 rounded-full ${barColor} transition-all duration-700 ease-out" style="width: ${barWidth}%;"></div>
                            </div>

                            <!-- Metrics Grid -->
                            <div class="grid grid-cols-3 text-sm clin-card-metric-label font-medium border-t pt-2 border-gray-300">
                                <div class="truncate">NTE (${item.uom}): <span class="clin-card-metric-value">${formattedNTE}</span></div>
                                <div class="text-center truncate">To Date: <span class="clin-card-metric-value">${formattedToDate}</span></div>
                                <div class="text-right truncate">Status: <span class="${textColor} font-extrabold">${status}</span></div>
                            </div>
                        </div>
                        <!-- End Individual Row Container -->
                    `;
                }).join('');

                // Section header and responsive grid for its cards
                return `
                    <!-- START: CLIN Section Wrapper (New Container) -->
                    <div class="clin-section-wrapper mb-6">
                        <h3 class="clin-section-header text-lg font-extrabold border-b-2 pb-2 mb-4">${section.title}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            ${cardsHtml}
                        </div>
                    </div>
                    <!-- END: CLIN Section Wrapper -->
                `;
            }).join('');

            container.innerHTML = sectionsHtml;
        }

        /**
         * Renders the Key Performance Indicator (KPI) cards.
         */
        function renderKPIs() {
            const kpisContainer = document.getElementById('kpis');
            
            const kpiItems = [
                { title: "Total Project Goal (CY)", value: projectData.projectGoalCY.toLocaleString(), icon: "fa-bullseye", color: "blue" },
                { title: "Volume Processed To Date (CY)", value: projectData.volumeToDateCY.toLocaleString(), icon: "fa-truck", color: "green" },
                { title: "NTE % Complete (CLIN 0001)", value: projectData.percentComplete.toFixed(2) + '%', icon: "fa-check-circle", color: "gold" },
                { title: "Project Days Elapsed (Mock)", value: projectData.projectDaysElapsed.toLocaleString(), icon: "fa-calendar", color: "red" }
            ];

            kpisContainer.innerHTML = kpiItems.map(item => {
                let iconClass = '';
                let borderColor = '';
                switch(item.color) {
                    case 'blue': iconClass = 'bg-blue-500'; borderColor = 'border-blue-500'; break;
                    case 'green': iconClass = 'bg-green-500'; borderColor = 'border-green-500'; break;
                    case 'gold': iconClass = 'bg-yellow-500'; borderColor = 'border-yellow-500'; break;
                    case 'red': iconClass = 'bg-red-500'; borderColor = 'border-red-500'; break;
                }

                // Apply glass-card to KPI containers
                return `
                    <div class="glass-card p-6 border-b-4 ${borderColor} flex items-center" style="border-width: 0; border-bottom-width: 4px;">
                        <div class="p-3 rounded-full ${iconClass} text-white mr-4 shadow-xl">
                            <!-- Using Lucide icons for aesthetics -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity">
                                ${item.icon.includes('bullseye') ? '<circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M4.93 4.93l14.14 14.14"/>' : ''}
                                ${item.icon.includes('truck') ? '<path d="M5 18H3c-1.1 0-2 .9-2 2v2h22v-2c0-1.1-.9-2-2-2h-3"/><path d="M7 18V8h10v10h2c1.1 0 2 .9 2 2v2H5v-2c0-1.1.9-2 2-2zM12 8l4 4-4 4-4-4z"/>' : ''}
                                ${item.icon.includes('check-circle') ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' : ''}
                                ${item.icon.includes('calendar') ? '<rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>' : ''}
                            </svg>
                        </div>
                        <div>
                            <p class="text-xl font-bold clin-card-metric-value">${item.value}</p>
                            <p class="text-sm clin-card-metric-label">${item.title}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Main initialization function
         */
        function initDashboard() {
            renderKPIs();
            renderVolumeChart();
            renderClinBreakdownCards();

            // Re-render charts on window resize for responsiveness
            window.addEventListener('resize', () => {
                renderVolumeChart();
            });
        }

        window.onload = initDashboard;
    </script>
</body>
</html>
